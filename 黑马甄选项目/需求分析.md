## 需求分析

### **班级出勤人数**

说明：统计指定时间段内，不同班级的出勤人数。打卡时间在上课前40分钟(否则认为无效)~上课时间点之内，且未早退，则为正常上课打卡。可以下钻到具体学生的出勤数据。跨天数据直接累加。

指标：出勤人数

维度：年、月、天

粒度：上午、下午、晚自习

条件：年、月

数据来源：教学实施与保障系统teach的

course_table_upload_detail班级课表、

tbh_student_signin_record学生打卡记录表、

tbh_class_time_table班级作息时间表。

### 班级出勤率

说明：统计指定时间段内，不同班级的学生出勤率。可以下钻到具体学生的出勤数据。出勤率=出勤人数/当日在读学员人数。

指标：出勤率

维度：年、月、天

粒度：上午、下午、晚自习

条件：年、月

数据来源：教学实施与保障系统的

course_table_upload_detail班级课表、

tbh_student_signin_record学生打卡记录表、

tbh_class_time_table班级作息时间表、

class_studying_student_count班级在读学生人数。

### 班级迟到人数

说明：统计指定时间段内，不同班级的迟到人数。上课10分钟后视为迟到。可以下钻到具体学生的迟到数据。跨天数据直接累加。

指标：迟到人数

维度：年、月、天

粒度：上午、下午、晚自习

条件：年、月

数据来源：教学实施与保障系统的

course_table_upload_detail班级课表、

tbh_student_signin_record学生打卡记录表、

tbh_class_time_table班级作息时间表。

### 班级迟到率

说明：统计指定时间段内，不同班级的学生迟到率。上课10分钟后视为迟到。可以下钻到具体学生的迟到数据。迟到率=迟到人数/当日在读学员人数。

指标：迟到率

维度：年、月、天

粒度：上午、下午、晚自习

条件：年、月

数据来源：教学实施与保障系统的

course_table_upload_detail班级课表、

tbh_student_signin_record学生打卡记录表、

tbh_class_time_table班级作息时间表、

class_studying_student_count班级在读学生人数。
SQL：

```sql
select dt.every_date,
       ctud.class_id,
       tssr.student_id,
       if(
           #上午正常打卡为0，迟到10分钟以上为1，其他(请假+旷课)为2
           sum(
               case
               #上午打卡时间是否在上课前40分钟~下课时间段之内
                   when time(tssr.signin_time) between TIMESTAMPADD(minute, -40, tctt.morning_begin_time) and tctt.morning_end_time
                       then 1   #上午来了
                   else 0 end   #上午没来
            ) > 0,  #打卡多次，只要有一次正常打卡，就会>0，返回true；否则没来，返回false
           if(
               sum(
                   case
               #上午打卡时间是否在上课前40分钟~上课后10分钟之内
                      when time(tssr.signin_time) between TIMESTAMPADD(minute, -40, tctt.morning_begin_time) and TIMESTAMPADD(minute, 10, tctt.morning_begin_time)
                          then 1    #正常出勤
                      else 0 end    #迟到
                ) > 0,              #有一次打卡是正常出勤，就会>0，返回true；否则迟到，返回false
               0,   #正常出勤
               1    #迟到
            ),
           2    #上午没来
        ) as morning_signin,
       if(
           #下午正常打卡为0，迟到10分钟以上为1，其他(请假+旷课)为2
                   sum(case
                           when time(tssr.signin_time) between TIMESTAMPADD(minute, -40, tctt.afternoon_begin_time) and tctt.afternoon_end_time
                               then 1
                           else 0 end) > 0,
                   if(sum(case
                              when time(tssr.signin_time) between TIMESTAMPADD(minute, -40, tctt.afternoon_begin_time) and TIMESTAMPADD(minute, 10, tctt.afternoon_begin_time)
                                  then 1
                              else 0 end) > 0, 0, 1), 2) as afternoon_signin,
       if(
           #晚自习正常打卡为0，迟到10分钟以上为1，其他(请假+旷课)为2
                   sum(case
                           when time(tssr.signin_time) between TIMESTAMPADD(minute, -20, tctt.evening_begin_time) and tctt.evening_end_time
                               then 1
                           else 0 end) > 0,
                   if(sum(case
                              when time(tssr.signin_time) between TIMESTAMPADD(minute, -20, tctt.evening_begin_time) and TIMESTAMPADD(minute, 10, tctt.evening_begin_time)
                                  then 1
                              else 0 end) > 0, 0, 1), 2) as evening_signin
from (
         #获取今天之前一周内的日期
         select datelist as every_date from calendar where datelist between '2019-09-01' and '2019-09-30'
     ) dt
         #日期课表不为空且不是开班典礼
         left join course_table_upload_detail ctud
                   on ctud.class_date = dt.every_date and ifnull(ctud.content, '') != '' and
                      ctud.content != '开班典礼'
    #学生打卡记录日期和班级匹配，且开启共屏进入学习
         left join tbh_student_signin_record tssr
                   on tssr.class_id = ctud.class_id and tssr.signin_date = dt.every_date and
                      tssr.share_state = 1
    #获取班级作息时间以判断是否按时出勤
         left join tbh_class_time_table tctt on tctt.id = tssr.time_table_id
     #按照日期、班级、学生分组统计
group by dt.every_date, ctud.class_id, tssr.student_id;
```



 

### 班级请假人数

说明：统计指定时间段内，不同班级的请假人数。跨天数据直接累加。

指标：请假人数

维度：年、月、天

粒度：上午、下午、晚自习

条件：年、月

数据来源：教学实施与保障系统的

student_leave_apply学生请假申请表、

tbh_class_time_table、

```
COMMENT '学生请假申请表' row format delimited fields terminated by '\t'
STORED AS orc
TBLPROPERTIES ('orc.compress'='ZLIB');
```

course_table_upload_detail班级课表。
SQL：





 ```sql
 select cud.class_date as dateinfo,
        cud.class_id,
        count(distinct sla.student_id) as morning_leave_count
 from student_leave_apply sla,
      tbh_class_time_table ct,
      course_table_upload_detail cud
 --       表关联
 where sla.class_id = ct.class_id = cud.class_id
 --   课程表，当天有课程内容
   AND cud.content IS NOT NULL
   AND cud.content != '开班典礼'
 --   作息时间表，数据在生效期范围内
   and cud.class_date between ct.use_begin_date and ct.use_end_date
 --   请假表，请假状态已审核通过，且没有取消、数据有效
   and sla.audit_state = 1
   and sla.cancel_state = 0
   and sla.valid_state = 1
 --   关联判断请假周期，请假时间周期要与课程和作息时间对比
 --      cud.class_date          课程表的上课日期     2020-09-16
 --      ct.morning_begin_time   作息表的早上上课时间  09:00:00
 --      请假结束时间 >= 2020-09-16 09:00:00 >= 请假开始时间，认为上午请假了
   and concat(cud.class_date, ' ', ct.morning_begin_time) >= sla.begin_time
   and concat(cud.class_date, ' ', ct.morning_begin_time) <= sla.end_time
 group by cud.class_date, cud.class_id;
 ```



### 班级请假率

说明：统计指定时间段内，不同班级的学生请假率。可以下钻到具体学生的请假数据。请假率=请假人数/当日在读学员人数。

指标：请假率

维度：年、月、天

粒度：上午、下午、晚自习

条件：年、月

数据来源：教学实施与保障系统的

student_leave_apply学生请假申请表、

class_studying_student_count班级在读学生人数。

### 班级旷课人数

说明：统计指定时间段内，不同班级的旷课人数。跨天数据直接累加。旷课人数=当日在读学员人数-出勤人数-请假人数。

指标：旷课人数

维度：年、月、天

粒度：上午、下午、晚自习

条件：年、月

数据来源：教学实施与保障系统的

course_table_upload_detail班级课表、

tbh_student_signin_record学生打卡记录表、

tbh_class_time_table班级作息时间表、

student_leave_apply学生请假申请表。

### 班级旷课率

说明：统计指定时间段内，不同班级的学生旷课率。旷课率=旷课人数/当日在读学员人数。

指标：旷课率

维度：年、月、天

粒度：上午、下午、晚自习

条件：年、月

数据来源：教学实施与保障系统的

course_table_upload_detail班级课表、

tbh_student_signin_record学生打卡记录表、

tbh_class_time_table班级作息时间表、

student_leave_apply学生请假申请表、

class_studying_student_count班级在读学生人数